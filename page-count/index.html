<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Track your daily reading progress and visualize pages read over time">
    <meta name="category" content="Utilities">
    <title>My Pages Read</title>
    <style>
      body {
        font-family: system-ui, sans-serif;
        max-width: 800px;
        margin: 20px auto;
        padding: 20px;
        line-height: 1.5;
        background: #f4f7f6;
      }

      .card {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }

      input {
        padding: 10px;
        width: 70%;
        border: 1px solid #ddd;
        border-radius: 4px;
      }

      button {
        padding: 10px 20px;
        cursor: pointer;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
      }

      button:hover {
        background: #0056b3;
      }

      /* Search Results Styles */
      #results {
        margin-top: 10px;
        border: 1px solid #eee;
        background: #fff;
        max-height: 300px;
        overflow-y: auto;
        position: relative;
        min-height: 60px;
      }

      #results.loading::after {
        content: 'Searching...';
        position: absolute;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        font-weight: 600;
        color: #444;
        background: rgba(255, 255, 255, 0.9);
        pointer-events: none;
        border-radius: 8px;
        z-index: 1;
      }

      #results.loading .result-item {
        opacity: 0.6;
      }

      .result-item {
        padding: 10px;
        border-bottom: 1px solid #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .result-item:hover {
        background: #f9f9f9;
      }

      .editable-pages {
        cursor: text;
        border-bottom: 1px dashed transparent;
        transition: border-color 0.2s;
      }

      .editable-pages:hover,
      .editable-pages:focus {
        border-color: #007bff;
      }

      .clear-btn {
        margin-top: 10px;
        background: #dc3545;
      }

      /* Reading List Styles */
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
      }

      th,
      td {
        text-align: left;
        padding: 12px;
        border-bottom: 1px solid #ddd;
      }

      .total-row {
        font-weight: bold;
        background: #e9ecef;
      }

      .empty-msg {
        color: #888;
        font-style: italic;
      }
    </style>
  </head>

  <body>

    <h2>ðŸ“š My Pages Read</h2>

    <div class="card">
      <h3>Search Books</h3>
      <div style="display: flex; gap: 10px;">
        <input type="text" id="bookInput" placeholder="Enter book title (e.g. 'The Hobbit')">
        <button onclick="searchBooks()">Search</button>
      </div>
      <div id="results"></div>
    </div>

    <div class="card">
      <h3>My Reading List</h3>
      <table>
        <thead>
          <tr>
            <th>Title</th>
            <th>Author</th>
            <th>Year</th>
            <th>Pages</th>
          </tr>
        </thead>
        <tbody id="bookList">
        </tbody>
        <tfoot>
          <tr class="total-row">
            <td colspan="3">Total Pages Tracked:</td>
            <td id="totalPageCount">0</td>
          </tr>
        </tfoot>
      </table>
      <div style="display: flex; justify-content: flex-end;">
        <button id="clearList" class="clear-btn" type="button">Clear list</button>
      </div>
    </div>

    <script>
      let myBooks = [];
      let typingTimer;                // Timer identifier for debounce
      const doneTypingInterval = 100;  // Time in ms
      const bookInput = document.getElementById('bookInput');
      const resultsDiv = document.getElementById('results');
      const bookListBody = document.getElementById('bookList');
      const totalDisplay = document.getElementById('totalPageCount');
      const clearListBtn = document.getElementById('clearList');
      let lastResultsHTML = '';
      let lastObservedValue = '';
      let lastQueriedText = '';
      let currentSearchRequestId = 0;

      // 1. Listen for the "Enter" key
      bookInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          clearTimeout(typingTimer); // Stop the idle timer if user hits Enter
          searchBooks();
        }
      });

      // 2. Listen for idle time (Debounce)
      bookInput.addEventListener('keyup', () => {
        const currentValue = bookInput.value;
        if (currentValue === lastObservedValue) {
          return;
        }
        lastObservedValue = currentValue;
        clearTimeout(typingTimer);

        if (!currentValue.trim()) {
          searchBooks();
          return;
        }

        typingTimer = setTimeout(searchBooks, doneTypingInterval);
      });

      clearListBtn.addEventListener('click', () => {
        if (!myBooks.length) {
          return;
        }
        myBooks = [];
        renderList();
        resultsDiv.classList.remove('loading');
        lastResultsHTML = '';
        lastQueriedText = '';
        lastObservedValue = '';
      });

      function loadBooks() {
        const stored = localStorage.getItem('trackedBooks');
        if (!stored) {
          myBooks = [];
          return;
        }
        try {
          myBooks = JSON.parse(stored) ?? [];
        } catch (error) {
          myBooks = [];
        }
      }

      function saveBooks() {
        localStorage.setItem('trackedBooks', JSON.stringify(myBooks));
      }

      function updateTotals() {
        const total = myBooks.reduce((sum, book) => sum + (Number(book.pages) || 0), 0);
        totalDisplay.innerText = total;
      }

      function attachPageEditor(span) {
        let editing = false;
        const index = Number(span.dataset.index);

        const finalize = () => {
          if (!editing) {
            return;
          }
          editing = false;
          span.setAttribute('contenteditable', 'false');
          let parsed = Number.parseInt(span.textContent.trim(), 10);
          if (Number.isNaN(parsed) || parsed < 0) {
            parsed = 0;
          }
          span.textContent = parsed;

          if (myBooks[index].pages !== parsed) {
            myBooks[index].pages = parsed;
            saveBooks();
            updateTotals();
          }
        };

        span.addEventListener('focus', () => {
          editing = true;
          span.setAttribute('contenteditable', 'true');
        });

        span.addEventListener('blur', finalize);

        span.addEventListener('keydown', (event) => {
          if (event.key === 'Enter') {
            event.preventDefault();
            span.blur();
          }
          if (event.key === 'Escape') {
            span.textContent = myBooks[index].pages;
            span.blur();
          }
        });

        span.addEventListener('pointerdown', () => {
          if (!editing) {
            span.focus();
          }
        });
      }

      function renderList() {
        bookListBody.innerHTML = '';

        if (myBooks.length === 0) {
          bookListBody.innerHTML = '<tr><td colspan="4" class="empty-msg">No books added yet.</td></tr>';
          updateTotals();
          saveBooks();
          return;
        }

        myBooks.forEach((book, index) => {
          const row = document.createElement('tr');

          const titleCell = document.createElement('td');
          titleCell.textContent = book.title;
          row.appendChild(titleCell);

          const authorCell = document.createElement('td');
          authorCell.textContent = book.author;
          row.appendChild(authorCell);

          const yearCell = document.createElement('td');
          yearCell.textContent = book.year;
          row.appendChild(yearCell);

          const pageCell = document.createElement('td');
          const pageSpan = document.createElement('span');
          pageSpan.className = 'editable-pages';
          const pageCount = Number(book.pages) || 0;
          pageSpan.textContent = pageCount;
          pageSpan.dataset.index = index;
          pageSpan.tabIndex = 0;
          pageSpan.setAttribute('contenteditable', 'false');
          pageCell.appendChild(pageSpan);
          row.appendChild(pageCell);

          bookListBody.appendChild(row);
          attachPageEditor(pageSpan);
        });

        updateTotals();
        saveBooks();
      }

      async function searchBooks() {
        const query = bookInput.value.trim();
        const requestId = ++currentSearchRequestId;

        if (!query) {
          resultsDiv.innerHTML = '';
          lastResultsHTML = '';
          lastQueriedText = '';
          resultsDiv.classList.remove('loading');
          return;
        }

        if (query === lastQueriedText) {
          resultsDiv.classList.remove('loading');
          return;
        }

        lastQueriedText = query;

        const hasResultItems = Boolean(resultsDiv.querySelector('.result-item'));
        if (hasResultItems) {
          resultsDiv.classList.add('loading');
        } else {
          resultsDiv.classList.remove('loading');
          resultsDiv.innerHTML = '<p style="padding:10px">Searching...</p>';
        }

        try {
          const response = await fetch(`https://www.googleapis.com/books/v1/volumes?q=intitle:${encodeURIComponent(query)}&maxResults=5`);
          const data = await response.json();

          if (requestId !== currentSearchRequestId) {
            return;
          }

          const books = (data.items ?? [])
            .map(item => {
              const info = item.volumeInfo;
              return {
                title: info.title || 'Unknown Title',
                author: info.authors ? info.authors[0] : 'Unknown Author',
                year: info.publishedDate ? info.publishedDate.split('-')[0] : 'N/A',
                pages: info.pageCount || 0
              };
            })
            .filter(book => book.pages > 0);

          const newResultsHtml = books.length
            ? books.map(renderResultItem).join('')
            : '<p style="padding:10px">No results found.</p>';

          resultsDiv.classList.remove('loading');

          if (newResultsHtml === lastResultsHTML) {
            return;
          }

          resultsDiv.innerHTML = newResultsHtml;
          lastResultsHTML = newResultsHtml;
        } catch (error) {
          if (requestId !== currentSearchRequestId) {
            return;
          }

          lastQueriedText = '';

          resultsDiv.classList.remove('loading');
          const errorHtml = '<p style="padding:10px; color:red">Error fetching data.</p>';

          if (errorHtml === lastResultsHTML) {
            return;
          }

          resultsDiv.innerHTML = errorHtml;
          lastResultsHTML = errorHtml;
        }
      }

      function renderResultItem(book) {
        const bookData = JSON.stringify(book).replace(/'/g, "&apos;");
        return `
                    <div class="result-item">
                        <span><strong>${book.title}</strong> by ${book.author} (${book.year}) - ${book.pages} pgs</span>
                        <button onclick='addBook(${bookData})'>Add</button>
                    </div>
                `;
      }

      function addBook(book) {
        myBooks.push(book);
        renderList();
        resultsDiv.innerHTML = '';
        lastResultsHTML = '';
        resultsDiv.classList.remove('loading');
        lastQueriedText = '';
        lastObservedValue = '';
        clearTimeout(typingTimer);
        bookInput.value = '';
      }

      loadBooks();
      renderList();
    </script>
  </body>

</html>