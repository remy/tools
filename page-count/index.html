<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal Book Tracker</title>
    <style>
      body {
        font-family: system-ui, sans-serif;
        max-width: 800px;
        margin: 20px auto;
        padding: 20px;
        line-height: 1.5;
        background: #f4f7f6;
      }

      .card {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }

      input {
        padding: 10px;
        width: 70%;
        border: 1px solid #ddd;
        border-radius: 4px;
      }

      button {
        padding: 10px 20px;
        cursor: pointer;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
      }

      button:hover {
        background: #0056b3;
      }

      /* Search Results Styles */
      #results {
        margin-top: 10px;
        border: 1px solid #eee;
        background: #fff;
        max-height: 300px;
        overflow-y: auto;
      }

      .result-item {
        padding: 10px;
        border-bottom: 1px solid #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .result-item:hover {
        background: #f9f9f9;
      }

      /* Reading List Styles */
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
      }

      th,
      td {
        text-align: left;
        padding: 12px;
        border-bottom: 1px solid #ddd;
      }

      .total-row {
        font-weight: bold;
        background: #e9ecef;
      }

      .empty-msg {
        color: #888;
        font-style: italic;
      }
    </style>
  </head>

  <body>

    <h2>ðŸ“š My Book Tracker</h2>

    <div class="card">
      <h3>Search Books</h3>
      <div style="display: flex; gap: 10px;">
        <input type="text" id="bookInput" placeholder="Enter book title (e.g. 'The Hobbit')">
        <button onclick="searchBooks()">Search</button>
      </div>
      <div id="results"></div>
    </div>

    <div class="card">
      <h3>My Reading List</h3>
      <table>
        <thead>
          <tr>
            <th>Title</th>
            <th>Author</th>
            <th>Year</th>
            <th>Pages</th>
          </tr>
        </thead>
        <tbody id="bookList">
        </tbody>
        <tfoot>
          <tr class="total-row">
            <td colspan="3">Total Pages Tracked:</td>
            <td id="totalPageCount">0</td>
          </tr>
        </tfoot>
      </table>
    </div>

    <script>
      let myBooks = [];
      let typingTimer;                // Timer identifier for debounce
      const doneTypingInterval = 600;  // Time in ms (0.6 seconds)
      const bookInput = document.getElementById('bookInput');

      // 1. Listen for the "Enter" key
      bookInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          clearTimeout(typingTimer); // Stop the idle timer if user hits Enter
          searchBooks();
        }
      });

      // 2. Listen for idle time (Debounce)
      bookInput.addEventListener('keyup', () => {
        clearTimeout(typingTimer);
        if (bookInput.value) {
          typingTimer = setTimeout(searchBooks, doneTypingInterval);
        }
      });

      async function searchBooks() {
        const query = bookInput.value.trim();
        const resultsDiv = document.getElementById('results');

        // Don't search if the input is empty
        if (!query) {
          resultsDiv.innerHTML = '';
          return;
        }

        resultsDiv.innerHTML = '<p style="padding:10px">Searching...</p>';

        try {
          const response = await fetch(`https://www.googleapis.com/books/v1/volumes?q=intitle:${encodeURIComponent(query)}&maxResults=5`);
          const data = await response.json();

          resultsDiv.innerHTML = '';

          if (!data.items) {
            resultsDiv.innerHTML = '<p style="padding:10px">No results found.</p>';
            return;
          }

          data.items.forEach(item => {
            const info = item.volumeInfo;
            const book = {
              title: info.title || 'Unknown Title',
              author: info.authors ? info.authors[0] : 'Unknown Author',
              year: info.publishedDate ? info.publishedDate.split('-')[0] : 'N/A',
              pages: info.pageCount || 0
            };

            const div = document.createElement('div');
            div.className = 'result-item';

            // Create a safe string for the onclick function
            const bookData = JSON.stringify(book).replace(/'/g, "&apos;");

            div.innerHTML = `
                        <span><strong>${book.title}</strong> by ${book.author} (${book.year}) - ${book.pages} pgs</span>
                        <button onclick='addBook(${bookData})'>Add</button>
                    `;
            resultsDiv.appendChild(div);
          });
        } catch (error) {
          resultsDiv.innerHTML = '<p style="padding:10px; color:red">Error fetching data.</p>';
        }
      }

      function addBook(book) {
        myBooks.push(book);
        renderList();
        document.getElementById('results').innerHTML = '';
        bookInput.value = '';
      }

      function renderList() {
        const listBody = document.getElementById('bookList');
        const totalDisplay = document.getElementById('totalPageCount');
        listBody.innerHTML = '';

        if (myBooks.length === 0) {
          listBody.innerHTML = '<tr><td colspan="4" class="empty-msg">No books added yet.</td></tr>';
          totalDisplay.innerText = '0';
          return;
        }

        let totalPages = 0;
        myBooks.forEach(book => {
          totalPages += book.pages;
          const row = `<tr>
                    <td>${book.title}</td>
                    <td>${book.author}</td>
                    <td>${book.year}</td>
                    <td>${book.pages}</td>
                </tr>`;
          listBody.innerHTML += row;
        });

        totalDisplay.innerText = totalPages;
      }

      renderList();
    </script>
  </body>

</html>